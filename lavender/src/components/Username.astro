---
import { getUser, getAllCiphers } from '@/data/db';
import { cipherToPath, getCipherLabel } from './solvers.js';

interface Props {
  name: string;
  type?: 'reddit' | 'discord' | 'generic' | 'youtube';
}

const { name, type: fallbackType = 'generic' } = Astro.props as Props;

const lookupKey = name.replace(/^u\//, '');
const platform = getUser(lookupKey)?.platform ?? fallbackType;

const solves: string[] = [];
const credits: string[] = [];
for (const cipher of getAllCiphers()) {
  const path = cipherToPath(cipher);
  if (cipher.solvers.includes(lookupKey)) solves.push(path);
  if (cipher.credits.some(entry => entry.users.includes(lookupKey))) credits.push(path);
}

const styles: Record<string, { color: string }> = {
  reddit: { color: '#FF4500' },
  discord: { color: '#5865F2' },
  generic: { color: '#ffc34a' },
  youtube: { color: '#ff3344' },
};

const style = styles[platform] ?? styles.generic;

const solvesData = solves.map((path: string) => ({ href: path, label: getCipherLabel(path) }));
const creditsData = credits.map((path: string) => ({ href: path, label: getCipherLabel(path) }));

const BASE = import.meta.env.BASE_URL.replace(/\/$/, '');
const profileHref = `${BASE}/users/${lookupKey}`;
---

<a href={profileHref} class="username-link"><span class="username-wrapper" style={`color: ${style.color}`}>{platform === 'reddit' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M6.167 8a.83.83 0 0 0-.83.83c0 .459.372.84.83.831a.831.831 0 0 0 0-1.661m1.843 3.647c.315 0 1.403-.038 1.976-.611a.23.23 0 0 0 0-.306.213.213 0 0 0-.306 0c-.353.363-1.126.487-1.67.487-.545 0-1.308-.124-1.671-.487a.213.213 0 0 0-.306 0 .213.213 0 0 0 0 .306c.564.563 1.652.61 1.977.61zm.992-2.807c0 .458.373.83.831.83s.83-.381.83-.83a.831.831 0 0 0-1.66 0z"/>
      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.828-1.165c-.315 0-.602.124-.812.325-.801-.573-1.9-.945-3.121-.993l.534-2.501 1.738.372a.83.83 0 1 0 .83-.869.83.83 0 0 0-.744.468l-1.938-.41a.2.2 0 0 0-.153.028.2.2 0 0 0-.086.134l-.592 2.788c-1.24.038-2.358.41-3.17.992-.21-.2-.496-.324-.81-.324a1.163 1.163 0 0 0-.478 2.224q-.03.17-.029.353c0 1.795 2.091 3.256 4.669 3.256s4.668-1.451 4.668-3.256c0-.114-.01-.238-.029-.353.401-.181.688-.592.688-1.069 0-.65-.525-1.165-1.165-1.165"/>
    </svg>
  )}{platform === 'discord' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M13.545 2.907a13.2 13.2 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.2 12.2 0 0 0-3.658 0 8 8 0 0 0-.412-.833.05.05 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.04.04 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032q.003.022.021.037a13.3 13.3 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019q.463-.63.818-1.329a.05.05 0 0 0-.01-.059l-.018-.011a9 9 0 0 1-1.248-.595.05.05 0 0 1-.02-.066l.015-.019q.127-.095.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.05.05 0 0 1 .053.007q.121.1.248.195a.05.05 0 0 1-.004.085 8 8 0 0 1-1.249.594.05.05 0 0 0-.03.03.05.05 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.2 13.2 0 0 0 4.001-2.02.05.05 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.03.03 0 0 0-.02-.019m-8.198 7.307c-.789 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612m5.316 0c-.788 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612"/>
    </svg>
  )}{platform === 'generic' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708"/>
    </svg>
  )}{platform === 'youtube' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.01 2.01 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.01 2.01 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31 31 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.01 2.01 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A100 100 0 0 1 7.858 2zM6.4 5.209v4.818l4.157-2.408z"/>
    </svg>
  )}<strong>{name}</strong>{solves.length > 0 && (
    <span class="solver-badge solver-badge-solves" data-popover-items={JSON.stringify(solvesData)} data-popover-title="Solves"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/></svg><span class="solver-badge-count">{solves.length}</span></span>
  )}{credits.length > 0 && (
    <span class="solver-badge solver-badge-credits" data-popover-items={JSON.stringify(creditsData)} data-popover-title="Credits"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708"/></svg><span class="solver-badge-count">{credits.length}</span></span>
  )}</span></a>

<style>
  .username-link {
    text-decoration: none;
    color: inherit;
  }

  .username-link:hover {
    text-decoration: none;
  }

  .username-wrapper {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    font-size: 0.85em;
    font-weight: 500;
    background: var(--sl-color-bg-nav, rgba(128, 128, 128, 0.1));
    padding: 0.05rem 0.4rem;
    border-radius: 9999px;
    vertical-align: baseline;
    line-height: 1.4;
  }

  .username-wrapper > svg {
    flex-shrink: 0;
    width: 0.9em;
    height: 0.9em;
  }

  .solver-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.15rem;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.05em 0.35em;
    border-radius: 9999px;
    cursor: pointer;
    line-height: 1.2;
    vertical-align: middle;
    margin-left: 0;
    min-width: 2.1em;
    box-sizing: border-box;
  }

  .solver-badge svg {
    vertical-align: middle;
  }

  .solver-badge-solves {
    background: #16a34a;
    color: #fff;
  }

  .solver-badge-credits {
    background: #2563eb;
    color: #fff;
  }
</style>

<script>
  function initSolverPopovers() {
    let activePopover: HTMLElement | null = null;

    function closeActive() {
      if (activePopover) {
        activePopover.remove();
        activePopover = null;
      }
    }

    document.addEventListener('click', (e) => {
      const badge = (e.target as Element).closest('.solver-badge');

      if (!badge) {
        closeActive();
        return;
      }

      e.stopPropagation();

      const itemsJson = badge.getAttribute('data-popover-items');
      const title = badge.getAttribute('data-popover-title');
      if (!itemsJson || !title) return;

      // If clicking the same badge that's already open, just close it
      if (activePopover && activePopover.dataset.forBadge === badge.getAttribute('data-popover-title') + '-' + badge.closest('.username-wrapper')?.textContent?.trim()) {
        closeActive();
        return;
      }

      closeActive();

      const items: { href: string; label: string }[] = JSON.parse(itemsJson);
      const popover = document.createElement('div');
      popover.className = 'solver-popover';
      popover.dataset.forBadge = title + '-' + badge.closest('.username-wrapper')?.textContent?.trim();

      const heading = document.createElement('strong');
      heading.textContent = title;
      popover.appendChild(heading);

      const list = document.createElement('ul');
      for (const item of items) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = item.href;
        a.textContent = item.label;
        li.appendChild(a);
        list.appendChild(li);
      }
      popover.appendChild(list);

      document.body.appendChild(popover);
      activePopover = popover;

      // Position above the badge
      const rect = badge.getBoundingClientRect();
      const popRect = popover.getBoundingClientRect();
      let left = rect.left + rect.width / 2 - popRect.width / 2;
      let top = rect.top - popRect.height - 8;

      // Keep within viewport
      if (left < 8) left = 8;
      if (left + popRect.width > window.innerWidth - 8) left = window.innerWidth - popRect.width - 8;
      if (top < 8) {
        top = rect.bottom + 8;
      }

      popover.style.left = `${left + window.scrollX}px`;
      popover.style.top = `${top + window.scrollY}px`;
    });

    document.addEventListener('scroll', closeActive, true);
  }

  // Inject popover styles once
  if (!document.getElementById('solver-popover-styles')) {
    const style = document.createElement('style');
    style.id = 'solver-popover-styles';
    style.textContent = `
      .solver-popover {
        position: absolute;
        background: var(--sl-color-bg-nav, #1e1e2e);
        border: 1px solid var(--sl-color-hairline, #444);
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        z-index: 10000;
        min-width: 10rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 0.8rem;
        white-space: nowrap;
        color: var(--sl-color-text, #ccc);
      }
      .solver-popover strong {
        display: block;
        margin-bottom: 0.25rem;
        color: var(--sl-color-white, #fff);
      }
      .solver-popover ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .solver-popover ul li {
        padding: 0.15rem 0;
      }
      .solver-popover ul li a {
        color: var(--sl-color-text-accent, #7c9aff);
        text-decoration: none;
      }
      .solver-popover ul li a:hover {
        text-decoration: underline;
      }
    `;
    document.head.appendChild(style);
  }

  initSolverPopovers();
  document.addEventListener('astro:after-swap', initSolverPopovers);
</script>
